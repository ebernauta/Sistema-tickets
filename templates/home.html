<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <link rel="stylesheet" href="{{ url_for ('static', filename='/css/chat.css')}}">
  <title>Sistema de ticket</title>
</head>

<body>
  <div class="text-center bg-dark-subtle">
    <h1>Sistema de tickets</h1>
  </div>
  <div class="container">
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom ">
      <a class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
        <img src="\static\img\logo.png" alt="logo" class="img-thumbnail" width="65" height="70">
        <span class="fs-3">&nbsp;&nbsp;Bienvenido, {{current_user.fullname}}</span>
      </a>
      <ul class="nav">
        <li class="nav-item m-1"><a href="{{url_for ('home') }}" class="btn btn-secondary" aria-current="page">Mis
            tickets</a></li>
        <li class="nav-item m-1"><a href="/generarTicket" data-bs-target="#modalnewticket" data-bs-toggle="modal"
            class="btn btn-secondary" aria-current="page">Crear ticket</a></li>
        <li class="nav-item m-1"><a href="{{ url_for ('logout') }}" class="btn btn-danger">Cerrar Sesión</a></li>
      </ul>
    </header>
    {%with messages = get_flashed_messages(with_categories=True)%}
    {%if messages%}
    {% for categories, message in messages %}
    <div class="container">
      <div class="alert alert-{{categories}} alert-dismissable" role="alert">
        {{message}}
      </div>
    </div>
    {%endfor%}
    {%endif%}
    {%endwith%}
  </div>

  {% for ticket in tickets %}
  <div class="card text-center container">
    <div class="card-header">
      TICKET ID: #{{ticket.0}}
    </div>
    <div class="card-body">
      <h5 class="card-title">Numero de contacto: {{ticket.3}} </h5>
      <p class="card-text"><b>Descripción:</b> {{ticket.4}}</p>
      {% if ticket.5 == 'Abierto'%}
      <a href="/ver-ticket/{{ticket.0}}" class="btn btn-success" data-ticket-id="{{ticket.0}}"
        data-bs-target="#modalverticket" data-bs-toggle="modal">Estado del ticket: {{ticket.5}}</a>
      <a href="/deleteTicket/{{ticket.0}}" data-bs-target="#modaldeleteticket{{ticket.0}}" data-bs-toggle="modal"
        class="btn btn-danger">Eliminar ticket</a>
      {% elif ticket.5 == 'Pendiente'%}
      <a href="/ver-ticket/{{ticket.0}}" class="btn btn-warning" data-ticket-id="{{ticket.0}}"
        data-bs-target="#modalverticket" data-bs-toggle="modal">Estado del ticket: {{ticket.5}}</a>
      <a href="/deleteTicket/{{ticket.0}}" data-bs-target="#modaldeleteticket{{ticket.0}}" data-bs-toggle="modal"
        class="btn btn-danger">Eliminar ticket</a>
      {% else %}
      <a class="btn btn-danger">Este ticket ha sido cerrado !</a>
      {%endif%}
    </div>
    {% if ticket.5 == 'Abierto' or ticket.5 == 'Pendiente' %}
    <div class="card-footer text-body-secondary">
      Ticket generado a las: {{ticket.6}}
    </div>
    {% else%}
    <div class="card-footer text-body-secondary">
      Ticket finalizado a las: {{ticket.6}}
    </div>
    {% endif%}
  </div><br>

  <!-- MODAL VIEW TICKET -->
  <div>
    <div id="modalverticket" class="modal fade" role="dialog">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header text-center">
            <h5 class="modal-title text-primary" style="align-content: center;">Ticket #ID {{ticket.0}}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Funcionario</label>
              <input type="text" name="funcionario" class="form-control" id="funcionario" value="{{ticket.1}}" disabled>
            </div><br>
            <div class="form-group">
              <label>Departamento</label>
              <input type="text" name="departamento" class="form-control" id="departamento" value="{{ticket.2}}"
                disabled>
            </div><br>
            <div class="form-group">
              <label>Descripcion</label>
              <textarea type="text" rows="10" name="descripcion" class="form-control" id="descripcion"
                disabled>{{ticket.4}}</textarea>
            </div><br>
            <div class="form-group">
              <label>Numero de contacto</label>
              <input type="text" id="numero_contacto" name="numero_contacto" class="form-control" value="{{ticket.3}}"
                disabled>
            </div><br>
            <h2 class="text-primary" style="text-align: center;">Chat de soporte</h2>
            <div id="chat-container"></div><br>
            <div class="container">
              <form id="chat-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="id_ticket" autocomplete="off" id="id_ticket">
                <div class="form-group">
                  <label>Responder ticket</label>
                  <input type="text" name="mensaje" id="mensaje" class="form-control"><br>
                  <input type="hidden" name="hora_mensaje" id="hora_mensaje" value="">
                </div>
                <button type="submit" class="btn btn-success">Enviar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- MODAL DELETE TICKET -->
  <div>
    <div id="modaldeleteticket{{ ticket.0 }}" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-danger" style="align-content: center;">Cerrar Ticket</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="text-center text-primary">
            <h5>¿Estas seguro de que desea cerrar este ticket?</h5>
          </div><br>
          <a href="/deleteTicket/{{ ticket.0 }}" class="btn btn-danger btn-sm">Cerrar ticket</a>
        </div>
      </div>
    </div>
  </div>
  {% endfor%}

  <!--MODAL NEW TICKET -->

  <div>
    <div id="modalnewticket" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-primary" style="align-content: center;">Crear ticket</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form action="{{ url_for('generarTicket') }}" method="POST">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <label for="departamento" class="form-label">Departamento</label>
              <select class="form-select" name="departamento" required>
                {% for departamento in departamentos%}
                <option>{{departamento.1}}</option>
                {% endfor %}
              </select><br>
              <label for="numeroContacto" class="form-label">Numero de contacto</label>
              <input type="text" class="form-control" name="numeroContacto"><br>
              <div class="form-floating">
                <textarea class="form-control" name="descripcion" id="floatingTextarea2"
                  style="height: 100px"></textarea>
                <label for="floatingTextarea2">Descripción del problema</label>
              </div><br>
              <div class="text-center">
                <button type="submit" class="btn btn-success mb-2">Generar ticket</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready(function () {
      function cargarMensajes(id_ticket) {
        $.ajax({
          type: 'GET',
          url: '/obtener_mensajes/' + id_ticket, // Agregar una barra diagonal antes de la variable
          success: function (response) {
            // Procesar la respuesta del servidor (los mensajes)
            for (let i = 0; i < response.length; i++) {
              const mensaje = response[i].mensaje;
              const hora_mensaje = response[i].hora_mensaje;
              const user = response[i].user;
              let message;
              message = `<div class="message sent"><p><span class="sender"><b>${user}</b>:</span> ${mensaje}</p><span class="timestamp">${hora_mensaje}</span></div>`;
              container.innerHTML += message;
            }

            // Hacer scroll hacia abajo para mostrar los mensajes recién cargados
            container.scrollTop = container.scrollHeight;
          },
          error: function (error) {
            console.log(error);
          },
        });
      }

      // Agregar el evento click al botón "Ver ticket"
      $(document).on('click', '[data-bs-target="#modalverticket"]', function () {
        var ticket_id = $(this).data('ticket-id');

        // Hacer la petición AJAX para obtener los detalles del ticket correspondiente
        $.ajax({
          url: '/ver-ticket/' + ticket_id,
          method: 'GET',
          success: function (response) {
            // Actualizar el contenido del modal con los detalles del ticket
            $('#modalverticket .modal-title').text('Ticket #ID ' + ticket_id);
            $('#funcionario').val(response.user_fullname);
            $('#departamento').val(response.departamento);
            $('#descripcion').text(response.descripcion);
            $('#estado').val(response.estado);
            $('#numero_contacto').val(response.numero_contacto)
            $('#id_ticket').val(ticket_id);

            //Limpia contenido del chat cada vez que se cargen los msg
            container.innerHTML = '';
            // Cargar los mensajes de chat para la ID del ticket especificada
            cargarMensajes(ticket_id);
          },
          error: function (xhr, status, error) {
            console.log(error);
          }
        });
      });
    });

    const container = document.getElementById('chat-container');
    let user = '{{current_user_fullname}}';
    console.log(user)
    $('#chat-form').submit(function (event) {
      event.preventDefault();
      console.log(user)
      // Obtener valor del campo de entrada
      const mensaje = $('#mensaje').val();

      // Validar que el campo de entrada no esté vacío
      if (mensaje.trim() === '') {
        alert('El campo de mensaje no puede estar vacío.');
        return;
      }

      // Obtener la fecha y hora actual
      const timestamp = new Date().toLocaleString();

      // Crear elemento de mensaje con el valor ingresado, el remitente y la fecha de envío
      const message = `<div class="message sent"><p><span class="sender"><b>${user}</b>:</span> ${mensaje}</p><span class="timestamp">${timestamp}</span></div>`;
      // Agregar elemento de mensaje al contenedor
      container.innerHTML += message;

      // Obtener valor del span de hora_respuesta
      const hora_mensaje = $('.timestamp').last().text();

      // Asignar valor al input oculto de hora_respuesta
      $('#hora_mensaje').val(hora_mensaje);



      // Hacer scroll hacia abajo para mostrar el mensaje recién enviado
      container.scrollTop = container.scrollHeight;

      // Enviar los datos del formulario al servidor utilizando AJAX
      const form_data = $(this).serialize();
      $.ajax({
        type: 'POST',
        url: '/enviar_respuesta',
        data: form_data,
        success: function (response) {
          console.log(response);
        },
        error: function (error) {
          console.log(error);
        },
      });
      // Limpiar campo de entrada
      $('#mensaje').val('');
    });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>